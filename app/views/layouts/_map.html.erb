<script type="text/javascript" >
$( document ).ready(function() {
  
  //old map handler
  // handler = Gmaps.build('Google');
  // handler.buildMap({
  //   provider: { },
  //   internal: {id: 'map'}}, function(){
  //   markers = handler.addMarkers(<%=raw @hash.to_json %>);
  //   handler.bounds.extendWith(markers);
  //   handler.fitMapToBounds(); 
  //   handler.getMap().setZoom(10);
  //   //handler.getMap().setCenter(bounds.getCenter());
		// //handler.getMap().setCenter({lat: 37.09024, lng: -100.712891});
  // });
  
  	//New Stuff
		
		var json_array;
    function createSidebarLi(json){
      return ("<li><a>" + json.infowindow + "</a></li>");
    };
    
    function bindLiToMarker($li, marker){
      $li.on('click', function(){
        handler.getMap().setZoom(14);
        marker.setMap(handler.getMap()); 
        marker.panTo();
        google.maps.event.trigger(marker.getServiceObject(), 'click');
      })
    };
    
    function createSidebar(json_array){
      console.log("json array:" + json_array);
      _.each(json_array, function(json){
        var $li = $( createSidebarLi(json) );
        $li.appendTo('#result_list');
        bindLiToMarker($li, json.marker);
      });
    };
    
    handler = Gmaps.build('Google');
    handler.buildMap({ internal: {id: 'map'}}, function(){
      json_array = <%= raw @hash.to_json %>;
      var festivals = <%= raw @fetched_festivals.to_json %>;
  
      console.log("here's the array:"+json_array);
      console.log("here's the fetched festivals:"+ festivals);
  
      var markers = handler.addMarkers(json_array);
    
      _.each(json_array, function(json, index){
          json.marker = markers[index];
      });
    
    createSidebar(json_array);
    handler.bounds.extendWith(markers);
    handler.fitMapToBounds();
    });
		
});	
  
</script>

